<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Transcriber</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme Sidebar Color System */
            --sidebar-bg: #ffffff;
            --sidebar-border: #e5e7eb;
            --main-content-bg: #fafafa;
            --nav-text-default: #6b7280;
            --nav-text-active: #374151;
            --nav-bg-hover: #f9fafb;
            --nav-bg-active: #f3f4f6;
            --accent-color: #1f2937;
            --user-section-border: #e5e7eb;
            --focus-ring: #374151;

            /* 8-point grid system */
            --space-1: 8px;
            --space-2: 16px;
            --space-3: 24px;
            --space-4: 32px;
            --space-5: 40px;
            --space-6: 48px;
            --space-7: 56px;
            --space-8: 64px;

            /* Typography scale */
            --text-xs: 11px;
            --text-sm: 12px;
            --text-base: 13px;
            --text-md: 14px;
            --text-lg: 16px;
            --text-xl: 18px;
            --text-2xl: 24px;
            --text-3xl: 30px;

            /* Font weights */
            --font-regular: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            /* Content colors */
            --color-black: #000000;
            --color-gray-900: #111827;
            --color-gray-800: #1f2937;
            --color-gray-700: #374151;
            --color-gray-600: #4b5563;
            --color-gray-500: #6b7280;
            --color-gray-400: #9ca3af;
            --color-gray-300: #d1d5db;
            --color-gray-200: #e5e7eb;
            --color-gray-100: #f3f4f6;
            --color-gray-50: #f9fafb;
            --color-white: #ffffff;

            /* Semantic colors */
            --color-error: #dc2626;
            --color-error-light: #fef2f2;
            --color-warning: #d97706;
            --color-warning-light: #fef3c7;
            --color-success: #059669;
            --color-success-light: #ecfdf5;

            /* Animation timing */
            --transition-fast: 150ms;
            --transition-base: 200ms;
            --transition-slow: 300ms;
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);

            /* Layout constraints */
            --sidebar-width: 280px;
            --content-max-width: 640px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: var(--text-lg);
            line-height: 1.5;
            color: var(--color-gray-900);
            background-color: var(--main-content-bg);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: "kern" 1, "liga" 1;
        }

        /* Application Shell Architecture */
        .app-shell {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Component */
        .sidebar {
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Transcripts Section in Sidebar */
        .transcripts-section {
            padding: var(--space-3) var(--space-2);
            border-top: 1px solid var(--sidebar-border);
            flex-shrink: 0;
        }
        
        .transcripts-section h3 {
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--nav-text-active);
            margin-bottom: var(--space-2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .transcript-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .transcript-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-1);
            font-size: var(--text-sm);
            color: var(--nav-text-default);
            border-radius: 3px;
            transition: background-color var(--transition-fast) var(--ease-out);
        }
        
        .transcript-item:hover {
            background-color: var(--nav-bg-hover);
        }
        
        .transcript-checkbox {
            width: 14px;
            height: 14px;
            accent-color: var(--accent-color);
            cursor: pointer;
        }
        
        .transcript-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: var(--font-medium);
        }
        
        .remove-transcript {
            background: none;
            border: none;
            color: var(--nav-text-default);
            cursor: pointer;
            padding: 2px;
            border-radius: 2px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast) var(--ease-out);
            font-size: 12px;
            line-height: 1;
        }
        
        .remove-transcript:hover {
            background-color: var(--color-gray-200);
            color: var(--nav-text-active);
        }
        
        .upload-transcript-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            font-size: var(--text-sm);
            color: var(--nav-text-default);
            background: none;
            border: 1px dashed var(--sidebar-border);
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            transition: all var(--transition-fast) var(--ease-out);
        }
        
        .upload-transcript-btn:hover {
            border-color: var(--nav-text-active);
            color: var(--nav-text-active);
            background-color: var(--nav-bg-hover);
        }

        .sidebar-header {
            padding: var(--space-3) var(--space-2);
            border-bottom: 1px solid var(--sidebar-border);
        }

        .app-title {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--nav-text-active);
            text-align: center;
        }

        /* Navigation System */
        .sidebar-nav {
            flex: 1;
            padding: var(--space-2) 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-2);
            margin: 0 var(--space-1);
            border-radius: 4px;
            color: var(--nav-text-default);
            text-decoration: none;
            font-size: var(--text-md);
            font-weight: var(--font-medium);
            line-height: 1.4;
            transition: all var(--transition-fast) var(--ease-out);
            cursor: pointer;
            border: none;
            background: none;
            width: calc(100% - var(--space-2));
        }

        .nav-item:hover {
            background-color: var(--nav-bg-hover);
            color: var(--nav-text-active);
        }

        .nav-item.active {
            background-color: var(--nav-bg-active);
            color: var(--nav-text-active);
            border-left: 3px solid var(--accent-color);
            margin-left: 0;
            padding-left: calc(var(--space-2) + var(--space-1) - 3px);
        }

        .nav-item:focus {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
        }

        .nav-icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        /* User Information Footer */
        .sidebar-footer {
            border-top: 1px solid var(--user-section-border);
            padding: var(--space-2);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .user-email {
            font-size: var(--text-base);
            font-weight: var(--font-regular);
            color: var(--nav-text-active);
        }

        .sign-out-link {
            font-size: var(--text-sm);
            font-weight: var(--font-regular);
            color: var(--nav-text-default);
            text-decoration: none;
            padding: var(--space-1) 0;
            transition: color var(--transition-fast) var(--ease-out);
        }

        .sign-out-link:hover {
            color: var(--nav-text-active);
        }

        .sign-out-link:focus {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Main Content Area */
        .main-content {
            background-color: var(--main-content-bg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .content-container {
            flex: 1;
            max-width: var(--content-max-width);
            margin: 0 auto;
            padding: var(--space-4) var(--space-3);
            width: 100%;
        }
        
        /* Full-width chat for AI Analysis */
        .full-width-content {
            flex: 1;
            width: calc(100vw - var(--sidebar-width) - var(--space-3));
            max-width: none;
            margin: 0;
            margin-left: 0;
            margin-right: calc(-1 * var(--space-3));
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Remove container padding for AI analysis tab */
        .content-container.ai-analysis-active {
            padding: 0 !important;
            padding-left: var(--space-3) !important;
            max-width: none !important;
            margin: 0 !important;
            width: 100% !important;
        }

        .tab-content {
            display: none;
            opacity: 0;
            transition: opacity var(--transition-base) var(--ease-out);
        }

        .tab-content.active {
            display: block;
            opacity: 1;
        }

        /* Transcription Tab Content */
        .transcription-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .transcription-title {
            font-size: var(--text-3xl);
            font-weight: var(--font-bold);
            color: var(--color-black);
            margin-bottom: var(--space-2);
            letter-spacing: -0.025em;
        }

        .transcription-description {
            font-size: var(--text-xl);
            color: var(--color-gray-600);
            line-height: 1.6;
            max-width: 480px;
            margin: 0 auto;
        }

        /* Form Styling */
        .transcription-workflow {
            display: flex;
            flex-direction: column;
        }

        .workflow-step {
            margin-bottom: var(--space-8);
            opacity: 0;
            animation: fadeInUp 0.6s var(--ease-out) forwards;
        }

        .workflow-step:nth-child(1) { animation-delay: 0.1s; }
        .workflow-step:nth-child(2) { animation-delay: 0.2s; }
        .workflow-step:nth-child(3) { animation-delay: 0.3s; }
        .workflow-step:nth-child(4) { animation-delay: 0.4s; }
        .workflow-step:nth-child(5) { animation-delay: 0.5s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(16px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-label {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .required-indicator {
            color: var(--color-error);
            font-size: var(--text-md);
            font-weight: var(--font-regular);
        }

        .step-description {
            font-size: var(--text-md);
            color: var(--color-gray-600);
            margin-top: var(--space-2);
            line-height: 1.5;
        }

        /* Form Controls */
        .form-textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background-color: var(--color-white);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: var(--text-md);
            line-height: 1.5;
            resize: vertical;
            transition: all var(--transition-base) var(--ease-out);
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--color-gray-900);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .form-textarea::placeholder {
            color: var(--color-gray-400);
        }

        .form-input {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background-color: var(--color-white);
            font-size: var(--text-lg);
            transition: all var(--transition-base) var(--ease-out);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-gray-900);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .form-input::placeholder {
            color: var(--color-gray-400);
        }

        .form-select {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background-color: var(--color-white);
            font-size: var(--text-lg);
            cursor: pointer;
            transition: all var(--transition-base) var(--ease-out);
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right var(--space-2) center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: var(--space-6);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--color-gray-900);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        /* Radio Button Group */
        .radio-group {
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: 6px;
            transition: background-color var(--transition-base) var(--ease-out);
        }

        .radio-option:hover {
            background-color: var(--color-gray-100);
        }

        .radio-option input[type="radio"] {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-gray-300);
            border-radius: 50%;
            background-color: var(--color-white);
            cursor: pointer;
            transition: all var(--transition-base) var(--ease-out);
            position: relative;
        }

        .radio-option input[type="radio"]:checked {
            border-color: var(--color-gray-900);
        }

        .radio-option input[type="radio"]:checked::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--color-gray-900);
        }

        .radio-option input[type="radio"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .radio-label {
            font-size: var(--text-lg);
            font-weight: var(--font-medium);
            color: var(--color-gray-900);
            cursor: pointer;
        }

        /* File Input */
        .file-input-wrapper {
            position: relative;
        }

        .file-input-hidden {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-area {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4);
            border: 2px dashed var(--color-gray-300);
            border-radius: 8px;
            background-color: var(--color-white);
            cursor: pointer;
            transition: all var(--transition-base) var(--ease-out);
        }

        .file-input-area:hover,
        .file-input-area.dragover {
            border-color: var(--color-gray-400);
            background-color: var(--color-gray-50);
        }

        .file-placeholder {
            color: var(--color-gray-500);
            font-size: var(--text-lg);
        }

        .file-placeholder.has-file {
            color: var(--color-gray-900);
            font-weight: var(--font-medium);
        }

        .browse-hint {
            color: var(--color-gray-400);
            font-size: var(--text-md);
            font-weight: var(--font-medium);
        }

        /* Conditional Fields */
        .conditional-field {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all var(--transition-slow) var(--ease-in-out);
        }

        .conditional-field.active {
            opacity: 1;
            max-height: 200px;
            margin-bottom: var(--space-8);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            font-weight: var(--font-semibold);
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all var(--transition-base) var(--ease-out);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background-color: var(--color-black);
            color: var(--color-white);
            padding: var(--space-3) var(--space-6);
            font-size: var(--text-lg);
        }

        .btn-primary:hover {
            background-color: var(--color-gray-800);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            background-color: var(--color-gray-400);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background-color: var(--color-white);
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-200);
            padding: var(--space-2) var(--space-4);
            font-size: var(--text-md);
        }

        .btn-secondary:hover {
            background-color: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        /* State Management */
        .app-state {
            text-align: center;
            padding: var(--space-8) 0;
        }

        .state-title {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-4);
        }

        .state-description {
            font-size: var(--text-lg);
            color: var(--color-gray-600);
            margin-bottom: var(--space-6);
            line-height: 1.6;
        }

        /* Loading States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-4);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--color-gray-200);
            border-top: 2px solid var(--color-gray-900);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-details {
            text-align: center;
        }

        .progress-text {
            font-weight: var(--font-semibold);
            color: var(--color-gray-900);
            margin-bottom: var(--space-1);
        }

        .progress-meta {
            font-size: var(--text-md);
            color: var(--color-gray-500);
        }

        /* Results & Notices */
        .results-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .notice {
            padding: var(--space-4);
            border-radius: 8px;
            font-size: var(--text-md);
            line-height: 1.5;
            margin-bottom: var(--space-6);
        }

        .notice-warning {
            background-color: var(--color-warning-light);
            color: var(--color-warning);
            border: 1px solid var(--color-warning);
        }

        .notice-error {
            background-color: var(--color-error-light);
            color: var(--color-error);
            border: 1px solid var(--color-error);
        }

        /* AI Analysis Tab Content */
        .ai-analysis-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }

        .ai-analysis-title {
            font-size: var(--text-3xl);
            font-weight: var(--font-bold);
            color: var(--color-black);
            margin-bottom: var(--space-2);
            letter-spacing: -0.025em;
        }

        .ai-analysis-description {
            font-size: var(--text-xl);
            color: var(--color-gray-600);
            line-height: 1.6;
            max-width: 480px;
            margin: 0 auto;
        }

        /* Full-Width AI Chat Interface */
        .ai-chat-full {
            height: 100vh;
            width: 100%;
            max-width: none;
            display: flex;
            flex-direction: column;
            background: var(--color-white);
        }

        .chat-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-gray-200);
            background: var(--color-white);
            flex-shrink: 0;
        }

        .chat-title {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--color-black);
            margin-bottom: var(--space-1);
        }

        .chat-subtitle {
            font-size: var(--text-lg);
            color: var(--color-gray-600);
            margin-bottom: var(--space-4);
        }

        .chat-actions {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .chat-action-btn {
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            border: 1px solid var(--color-gray-200);
            background: var(--color-white);
            color: var(--color-gray-700);
            cursor: pointer;
            border-radius: 4px;
            transition: all var(--transition-fast) var(--ease-out);
        }

        .chat-action-btn:hover:not(:disabled) {
            background: var(--color-gray-100);
            border-color: var(--color-gray-300);
        }

        .chat-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-action-btn.primary {
            background: var(--color-black);
            color: var(--color-white);
            border-color: var(--color-black);
        }

        .chat-action-btn.primary:hover:not(:disabled) {
            background: var(--color-gray-800);
        }

        .chat-messages-area {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
            background: var(--color-white);
        }

        .chat-messages {
            width: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
            max-width: none;
        }

        .ai-message, .user-message {
            display: flex;
            flex-direction: column;
            max-width: 90%;
        }

        .ai-message {
            align-self: flex-start;
            margin-right: auto;
        }

        .user-message {
            align-self: flex-end;
            margin-left: auto;
        }

        .message-content {
            padding: var(--space-4);
            border-radius: 16px;
            line-height: 1.6;
            word-wrap: break-word;
            font-size: var(--text-lg);
        }

        .ai-message .message-content {
            background: var(--color-gray-100);
            color: var(--color-gray-900);
            border-bottom-left-radius: 4px;
        }

        .user-message .message-content {
            background: var(--color-black);
            color: var(--color-white);
            border-bottom-right-radius: 4px;
        }

        .message-content {
            font-weight: var(--font-regular);
            line-height: 1.7;
        }

        .message-content h1 {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            margin: var(--space-4) 0 var(--space-3) 0;
            color: inherit;
        }

        .message-content h2 {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            margin: var(--space-3) 0 var(--space-2) 0;
            color: inherit;
        }

        .message-content h3 {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            margin: var(--space-2) 0 var(--space-1) 0;
            color: inherit;
        }

        .message-content p {
            margin: var(--space-2) 0;
            font-weight: var(--font-regular);
        }

        .message-content ul {
            margin: var(--space-2) 0;
            padding-left: var(--space-4);
        }

        .message-content li {
            margin: var(--space-1) 0;
            font-weight: var(--font-regular);
        }

        .message-content strong {
            font-weight: var(--font-semibold);
            color: inherit;
        }

        .message-content em {
            font-style: italic;
            font-weight: var(--font-regular);
        }

        .typing-indicator {
            align-self: flex-start;
            max-width: 90%;
            display: none;
            align-items: center;
            gap: var(--space-2);
            color: var(--color-gray-500);
            font-style: italic;
            font-size: var(--text-lg);
            padding: var(--space-4);
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: var(--space-1);
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--color-gray-400);
            animation: typing-bounce 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing-bounce {
            0%, 60%, 100% { 
                transform: translateY(0); 
                opacity: 0.4; 
            }
            30% { 
                transform: translateY(-6px); 
                opacity: 1; 
            }
        }

        .chat-input-area {
            border-top: 1px solid var(--color-gray-200);
            background: var(--color-white);
            flex-shrink: 0;
        }

        .chat-input-container {
            width: 100%;
            max-width: none;
            margin: 0;
            display: flex;
            gap: var(--space-3);
            padding: var(--space-4);
            align-items: flex-end;
        }

        .chat-input-container textarea {
            flex: 1;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-200);
            border-radius: 12px;
            background: var(--color-gray-50);
            font-family: inherit;
            font-size: var(--text-lg);
            resize: none;
            min-height: 52px;
            max-height: 120px;
            transition: all var(--transition-base) var(--ease-out);
            line-height: 1.4;
        }

        .chat-input-container textarea:focus {
            outline: none;
            border-color: var(--color-gray-400);
            background: var(--color-white);
        }

        .chat-input-container textarea:disabled {
            background: var(--color-gray-100);
            color: var(--color-gray-500);
            cursor: not-allowed;
        }

        .chat-send-btn {
            background: var(--color-black);
            color: var(--color-white);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast) var(--ease-out);
            flex-shrink: 0;
        }

        .chat-send-btn:hover:not(:disabled) {
            background: var(--color-gray-800);
            transform: translateY(-1px);
        }

        .chat-send-btn:disabled {
            background: var(--color-gray-400);
            cursor: not-allowed;
            transform: none;
        }

        .upload-file-input {
            display: none;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Mobile Responsive Design */
        @media (max-width: 1024px) {
            .app-shell {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .sidebar {
                grid-row: 2;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 80px;
                flex-direction: row;
                border-right: none;
                border-top: 1px solid var(--sidebar-border);
                z-index: 100;
            }

            .sidebar-header {
                display: none;
            }

            .sidebar-nav {
                flex-direction: row;
                justify-content: center;
                flex: 1;
                padding: var(--space-2);
                gap: var(--space-4);
            }

            .sidebar-footer {
                display: none;
            }

            .nav-item {
                flex-direction: column;
                gap: var(--space-1);
                text-align: center;
                font-size: var(--text-sm);
                min-width: 80px;
                margin: 0;
                padding: var(--space-1);
            }

            .nav-item.active {
                border-left: none;
                border-bottom: 3px solid var(--accent-color);
                padding-left: var(--space-1);
            }

            .main-content {
                padding-bottom: 80px;
            }

            .content-container {
                padding: var(--space-3) var(--space-2);
            }
        }

        @media (max-width: 640px) {
            .content-container {
                padding: var(--space-2);
            }

            .transcription-title,
            .ai-analysis-title {
                font-size: var(--text-2xl);
            }

            .radio-group {
                flex-direction: column;
                gap: var(--space-2);
            }

            .results-actions {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 280px;
            }
        }

        /* Focus Management & Accessibility */
        .focus-trap:focus {
            outline: 2px solid var(--focus-ring);
            outline-offset: 2px;
        }

        /* High Contrast Support */
        @media (prefers-contrast: high) {
            :root {
                --sidebar-border: #666666;
                --color-gray-200: #888888;
                --color-gray-300: #666666;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <!-- Light Theme Sidebar -->
        <aside class="sidebar" role="navigation" aria-label="Main navigation">
            <div class="sidebar-header">
                <h1 class="app-title">Class Transcriber</h1>
            </div>

            <nav class="sidebar-nav">
                <button class="nav-item active" data-tab="transcription" role="tab" aria-selected="true" aria-controls="transcription-content">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    <span>New Transcription</span>
                </button>

                <button class="nav-item" data-tab="analysis" role="tab" aria-selected="false" aria-controls="analysis-content">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2-7h-3V2h-2v2H8V2H6v2H3c-1.1 0-1.99.9-1.99 2L1 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                    </svg>
                    <span>AI Analysis</span>
                </button>
            </nav>

            <!-- Transcripts Section (only visible on AI Analysis tab) -->
            <div class="transcripts-section" id="transcripts-section" style="display: none;">
                <h3>Transcripts & Materials</h3>
                <div class="transcript-list" id="transcript-list">
                    <!-- Transcript items will be added here -->
                </div>
                <button type="button" class="upload-transcript-btn" id="upload-transcript-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Add files
                </button>
                <input type="file" class="upload-file-input" id="hidden-file-input" multiple accept=".pdf,.csv">
            </div>

            {% if user %}
            <div class="sidebar-footer">
                <div class="user-info">
                    <span class="user-email">{{ user.email }}</span>
                    <a href="{{ url_for('logout') }}" class="sign-out-link">Sign out</a>
                </div>
            </div>
            {% endif %}
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" role="main">
            <div class="content-container">
                <!-- New Transcription Tab Content -->
                <div class="tab-content active" id="transcription-content" role="tabpanel" aria-labelledby="transcription-tab">
                    <div class="transcription-header">
                        <h2 class="transcription-title">Create New Transcription</h2>
                        <p class="transcription-description">
                            Transform classroom recordings into structured transcripts with integrated Forum metadata
                        </p>
                    </div>

                    <div class="workflow-container" id="workflow-container">
                        <form class="transcription-workflow" id="transcription-form" novalidate>
                            <div class="workflow-step">
                                <label class="step-label" for="curl_command">
                                    Forum session data
                                    <span class="required-indicator" aria-label="required">*</span>
                                </label>
                                <textarea 
                                    class="form-textarea" 
                                    id="curl_command" 
                                    name="curl_command" 
                                    placeholder="Paste the cURL command from Chrome DevTools (Network tab → right-click self request → Copy as cURL)"
                                    required
                                    aria-describedby="curl-help"
                                ></textarea>
                                <p class="step-description" id="curl-help">
                                    This captures your Forum authentication to access class metadata and attendance records
                                </p>
                            </div>

                            <div class="workflow-step">
                                <fieldset>
                                    <legend class="step-label">
                                        Recording source
                                        <span class="required-indicator" aria-label="required">*</span>
                                    </legend>
                                    <div class="radio-group" role="radiogroup">
                                        <label class="radio-option">
                                            <input type="radio" name="audio_source" value="upload" checked>
                                            <span class="radio-label">Upload file</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="audio_source" value="url">
                                            <span class="radio-label">Direct URL</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="audio_source" value="drive">
                                            <span class="radio-label">Google Drive</span>
                                        </label>
                                    </div>
                                </fieldset>
                            </div>

                            <div class="workflow-step conditional-field active" id="upload-section">
                                <label class="step-label" for="audio_file">Recording file</label>
                                <div class="file-input-wrapper">
                                    <input 
                                        type="file" 
                                        class="file-input-hidden" 
                                        id="audio_file" 
                                        name="audio_file" 
                                        accept="audio/*,video/*,.mp3,.mp4,.wav,.m4a,.aac,.ogg"
                                        aria-describedby="file-help"
                                    >
                                    <div class="file-input-area" role="button" tabindex="0" aria-labelledby="file-label">
                                        <span class="file-placeholder" id="file-label">Choose audio or video file</span>
                                        <span class="browse-hint">Browse files</span>
                                    </div>
                                </div>
                                <p class="step-description" id="file-help">
                                    Supported formats: MP3, MP4, WAV, M4A, AAC, OGG (up to 500MB)
                                </p>
                            </div>

                            <div class="workflow-step conditional-field" id="url-section">
                                <label class="step-label" for="audio_url">Recording URL</label>
                                <input 
                                    type="url" 
                                    class="form-input" 
                                    id="audio_url" 
                                    name="audio_url" 
                                    placeholder="https://example.com/recording.mp4"
                                    aria-describedby="url-help"
                                >
                                <p class="step-description" id="url-help">
                                    Direct link to the audio or video file (signed URLs supported)
                                </p>
                            </div>

                            <div class="workflow-step conditional-field" id="drive-section">
                                <label class="step-label" for="drive_path">Google Drive path</label>
                                <input 
                                    type="text" 
                                    class="form-input" 
                                    id="drive_path" 
                                    name="drive_path" 
                                    placeholder="/content/drive/MyDrive/recordings/class.mp4"
                                    aria-describedby="drive-help"
                                >
                                <p class="step-description" id="drive-help">
                                    Full path to file in your mounted Google Drive directory
                                </p>
                            </div>

                            <div class="workflow-step">
                                <label class="step-label" for="privacy_mode">Privacy configuration</label>
                                <select class="form-select" id="privacy_mode" name="privacy_mode" aria-describedby="privacy-help">
                                    <option value="names">Show student names</option>
                                    <option value="ids">Anonymize to ID numbers</option>
                                    <option value="both">Generate both versions</option>
                                </select>
                                <p class="step-description" id="privacy-help">
                                    Controls how student identities appear in the generated transcript
                                </p>
                            </div>

                            <div class="workflow-step">
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    <span>Begin transcription</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Progress State -->
                    <div class="app-state hidden" id="progress-state">
                        <div class="loading-container">
                            <div class="loading-spinner" role="progressbar" aria-label="Processing transcription"></div>
                            <div class="progress-details">
                                <p class="progress-text" id="progress-text">Processing transcription</p>
                                <p class="progress-meta">Estimated completion: 20-30 minutes</p>
                                <p class="state-description" id="status-message">Initializing transcription engine...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Success State -->
                    <div class="app-state hidden" id="success-state">
                        <h3 class="state-title">Transcription complete</h3>
                        <p class="state-description">Your class recording has been successfully transcribed and processed.</p>
                        
                        <div class="results-actions">
                            <a href="#" class="btn btn-primary" id="download-pdf">
                                <span>Download PDF</span>
                            </a>
                            <a href="#" class="btn btn-primary" id="download-csv">
                                <span>Download CSV</span>
                            </a>
                        </div>

                        <div class="notice notice-warning">
                            <strong>Accuracy notice:</strong> Always manually verify critical information. Automated transcription may contain errors, especially with multiple speakers, technical terms, or background noise.
                        </div>

                        <button type="button" class="btn btn-secondary" id="new-transcription">
                            Create new transcription
                        </button>
                    </div>

                    <!-- Error State -->
                    <div class="app-state hidden" id="error-state">
                        <h3 class="state-title">Processing failed</h3>
                        <div class="notice notice-error" id="error-message" role="alert">
                            An unexpected error occurred during processing. Please try again.
                        </div>
                        <button type="button" class="btn btn-secondary" id="retry-btn">
                            Try again
                        </button>
                    </div>
                </div>

                <!-- AI Analysis Tab Content -->
                <div class="tab-content full-width-content" id="analysis-content" role="tabpanel" aria-labelledby="analysis-tab">
                    <div class="ai-chat-full">
                        <!-- Chat Header -->
                        <div class="chat-header">
                            <h2 class="chat-title">AI Transcript Analysis</h2>
                            <p class="chat-subtitle">Upload and analyze classroom transcripts to gain insights on student participation and learning outcomes</p>
                            <div class="chat-actions">
                                <button type="button" class="chat-action-btn primary" id="initial-analysis-btn" disabled>
                                    Initial Analysis
                                </button>
                                <button type="button" class="chat-action-btn" id="clear-analysis-btn">
                                    Clear Chat
                                </button>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div class="chat-messages-area">
                            <div class="chat-messages" id="ai-chat-messages">
                                <div class="ai-message">
                                    <div class="message-content">
                                        Ready to find out what really happened in your class? Upload a transcript and I'll spill the academic tea.
                                    </div>
                                </div>
                                
                                <!-- Typing Indicator -->
                                <div class="typing-indicator" id="typing-indicator">
                                    <span>AI Assistant is typing</span>
                                    <div class="typing-dots">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div class="chat-input-area">
                            <div class="chat-input-container">
                                <textarea 
                                    id="ai-chat-input" 
                                    placeholder="Ask questions about your transcripts..."
                                    disabled
                                ></textarea>
                                <button type="button" class="chat-send-btn" id="ai-send-btn" disabled>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Prevent double initialization
        window.transcriptionAppInitialized = true;
        window.aiChatInitialized = true;
        
        // Tab Navigation System
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.nav-item');
            const tabContents = document.querySelectorAll('.tab-content');

            function switchTab(targetTab) {
                // Update tab buttons
                tabButtons.forEach(button => {
                    button.classList.remove('active');
                    button.setAttribute('aria-selected', 'false');
                });

                // Update tab content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });

                // Activate selected tab
                const activeButton = document.querySelector(`[data-tab="${targetTab}"]`);
                const activeContent = document.getElementById(`${targetTab}-content`);

                if (activeButton && activeContent) {
                    activeButton.classList.add('active');
                    activeButton.setAttribute('aria-selected', 'true');
                    activeContent.classList.add('active');
                }

                // Show/hide transcripts section based on tab
                const transcriptsSection = document.getElementById('transcripts-section');
                const contentContainer = document.querySelector('.content-container');
                
                if (targetTab === 'analysis') {
                    transcriptsSection.style.display = 'block';
                    contentContainer.classList.add('ai-analysis-active');
                } else {
                    transcriptsSection.style.display = 'none';
                    contentContainer.classList.remove('ai-analysis-active');
                }
            }

            // Tab button event listeners
            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetTab = button.getAttribute('data-tab');
                    switchTab(targetTab);
                });

                button.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        button.click();
                    }
                });
            });

            // Transcription Form Logic
            const radioInputs = document.querySelectorAll('input[name="audio_source"]');
            const sections = {
                upload: document.getElementById('upload-section'),
                url: document.getElementById('url-section'),
                drive: document.getElementById('drive-section')
            };

            function toggleSections(activeValue) {
                Object.keys(sections).forEach(key => {
                    const section = sections[key];
                    if (key === activeValue) {
                        section.classList.add('active');
                        section.setAttribute('aria-hidden', 'false');
                    } else {
                        section.classList.remove('active');
                        section.setAttribute('aria-hidden', 'true');
                    }
                });
            }

            radioInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.checked) {
                        toggleSections(this.value);
                    }
                });
            });

            // File input enhancements
            function setupFileInput(inputId, areaSelector, labelId) {
                const fileInput = document.getElementById(inputId);
                const fileArea = document.querySelector(areaSelector);
                const fileLabel = labelId ? document.getElementById(labelId) : fileArea.querySelector('.file-placeholder');

                if (fileInput && fileArea) {
                    fileArea.addEventListener('click', () => fileInput.click());
                    fileArea.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            fileInput.click();
                        }
                    });

                    fileInput.addEventListener('change', function() {
                        const files = this.files;
                        if (files.length > 0) {
                            if (files.length === 1) {
                                fileLabel.textContent = files[0].name;
                            } else {
                                fileLabel.textContent = `${files.length} files selected`;
                            }
                            fileLabel.classList.add('has-file');
                            
                            // Enable analysis button for AI tab
                            if (inputId === 'analysis_files') {
                                document.getElementById('initial-analysis-btn').disabled = false;
                            }
                        } else {
                            fileLabel.textContent = fileLabel.getAttribute('data-original') || 'Choose files';
                            fileLabel.classList.remove('has-file');
                            
                            if (inputId === 'analysis_files') {
                                document.getElementById('initial-analysis-btn').disabled = true;
                            }
                        }
                    });

                    // Drag and drop support
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        fileArea.addEventListener(eventName, preventDefaults, false);
                    });

                    function preventDefaults(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    ['dragenter', 'dragover'].forEach(eventName => {
                        fileArea.addEventListener(eventName, () => fileArea.classList.add('dragover'), false);
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        fileArea.addEventListener(eventName, () => fileArea.classList.remove('dragover'), false);
                    });

                    fileArea.addEventListener('drop', function(e) {
                        const dt = e.dataTransfer;
                        const files = dt.files;
                        if (files.length > 0) {
                            fileInput.files = files;
                            const event = new Event('change', { bubbles: true });
                            fileInput.dispatchEvent(event);
                        }
                    }, false);
                }
            }

            // Initialize file inputs
            setupFileInput('audio_file', '.file-input-area', 'file-label');

            // Store original placeholder text
            document.querySelectorAll('.file-placeholder').forEach(placeholder => {
                placeholder.setAttribute('data-original', placeholder.textContent);
            });

            // Initialize with default state
            toggleSections('upload');

            // AI Chat State
            let transcriptFiles = [];

            // AI Chat functionality
            const hiddenFileInput = document.getElementById('hidden-file-input');
            const uploadTranscriptBtn = document.getElementById('upload-transcript-btn');
            const transcriptList = document.getElementById('transcript-list');
            const initialAnalysisBtn = document.getElementById('initial-analysis-btn');
            const clearAnalysisBtn = document.getElementById('clear-analysis-btn');
            const chatInput = document.getElementById('ai-chat-input');
            const sendBtn = document.getElementById('ai-send-btn');
            const chatMessagesContainer = document.getElementById('ai-chat-messages');
            const typingIndicator = document.getElementById('typing-indicator');

            // Handle sidebar file upload
            uploadTranscriptBtn.addEventListener('click', function() {
                hiddenFileInput.click();
            });

            hiddenFileInput.addEventListener('change', function() {
                const files = Array.from(this.files);
                if (files.length > 0) {
                    files.forEach(file => {
                        const fileId = Date.now() + Math.random();
                        transcriptFiles.push({
                            id: fileId,
                            file: file,
                            enabled: true
                        });
                    });
                    updateTranscriptList();
                    enableChatInterface();
                    this.value = ''; // Reset input
                }
            });

            function updateTranscriptList() {
                transcriptList.innerHTML = '';
                
                transcriptFiles.forEach((fileObj) => {
                    const transcriptItem = document.createElement('div');
                    transcriptItem.className = 'transcript-item';
                    transcriptItem.innerHTML = `
                        <input type="checkbox" class="transcript-checkbox" ${fileObj.enabled ? 'checked' : ''} 
                               onchange="toggleTranscript('${fileObj.id}', this.checked)">
                        <span class="transcript-name" title="${fileObj.file.name}">${fileObj.file.name}</span>
                        <button type="button" class="remove-transcript" onclick="removeTranscript('${fileObj.id}')">
                            ×
                        </button>
                    `;
                    transcriptList.appendChild(transcriptItem);
                });

                // Update interface state
                if (transcriptFiles.length > 0 && transcriptFiles.some(f => f.enabled)) {
                    enableChatInterface();
                } else {
                    disableChatInterface();
                }
            }

            function toggleTranscript(fileId, enabled) {
                const fileObj = transcriptFiles.find(f => f.id == fileId);
                if (fileObj) {
                    fileObj.enabled = enabled;
                    updateTranscriptList();
                }
            }

            function removeTranscript(fileId) {
                transcriptFiles = transcriptFiles.filter(f => f.id != fileId);
                updateTranscriptList();
            }

            function enableChatInterface() {
                initialAnalysisBtn.disabled = false;
                chatInput.disabled = false;
                sendBtn.disabled = false;
            }

            function disableChatInterface() {
                initialAnalysisBtn.disabled = true;
                chatInput.disabled = true;
                sendBtn.disabled = true;
            }

            // Make functions global for onclick handlers
            window.toggleTranscript = toggleTranscript;
            window.removeTranscript = removeTranscript;

            // Initial Analysis
            initialAnalysisBtn.addEventListener('click', function() {
                const enabledFiles = transcriptFiles.filter(f => f.enabled);
                if (enabledFiles.length === 0) return;
                
                sendAIMessage('', true); // Send as initial analysis
            });

            // Clear Chat
            clearAnalysisBtn.addEventListener('click', function() {
                // Keep only the welcome message
                const welcomeMessage = chatMessagesContainer.querySelector('.ai-message');
                chatMessagesContainer.innerHTML = '';
                chatMessagesContainer.appendChild(welcomeMessage);
                
                // Add typing indicator back
                const newTypingIndicator = document.createElement('div');
                newTypingIndicator.className = 'typing-indicator';
                newTypingIndicator.id = 'typing-indicator';
                newTypingIndicator.innerHTML = `
                    <span>AI Assistant is typing</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                `;
                chatMessagesContainer.appendChild(newTypingIndicator);
            });

            // Send Message
            function sendMessage() {
                const message = chatInput.value.trim();
                const enabledFiles = transcriptFiles.filter(f => f.enabled);
                if (!message || enabledFiles.length === 0) return;

                // Add user message to chat
                addUserMessage(message);
                
                // Clear input
                chatInput.value = '';
                
                // Send to AI
                sendAIMessage(message, false);
            }

            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            function addUserMessage(message) {
                const userMessage = document.createElement('div');
                userMessage.className = 'user-message';
                userMessage.innerHTML = `
                    <div class="message-content">${escapeHtml(message)}</div>
                `;
                
                // Insert before typing indicator
                chatMessagesContainer.insertBefore(userMessage, typingIndicator);
                scrollToBottom();
            }

            function addAIMessage(message) {
                const aiMessage = document.createElement('div');
                aiMessage.className = 'ai-message';
                aiMessage.innerHTML = `
                    <div class="message-content">${formatAIResponse(message)}</div>
                `;
                
                // Insert before typing indicator
                chatMessagesContainer.insertBefore(aiMessage, typingIndicator);
                scrollToBottom();
            }

            function showTypingIndicator() {
                typingIndicator.classList.add('active');
                scrollToBottom();
            }

            function hideTypingIndicator() {
                typingIndicator.classList.remove('active');
            }

            function scrollToBottom() {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatAIResponse(text) {
                // Enhanced markdown formatting
                let formatted = text
                    // Handle headings first (with emojis)
                    .replace(/^(#{1,3})\s*(.*)$/gm, function(match, hashes, content) {
                        const level = hashes.length;
                        return `<h${level}>${content.trim()}</h${level}>`;
                    })
                    // Handle bold text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    // Handle italic text  
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    // Handle line breaks
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    // Handle bullet points
                    .replace(/^[\-\*]\s+(.*$)/gm, '<li>$1</li>');
                
                // Wrap bullet points in ul tags
                formatted = formatted.replace(/((<li>.*?<\/li>\s*)+)/g, '<ul>$1</ul>');
                
                // Wrap in paragraphs
                if (!formatted.startsWith('<h') && !formatted.startsWith('<ul')) {
                    formatted = '<p>' + formatted + '</p>';
                }
                
                return formatted;
            }

            async function sendAIMessage(message, isInitialAnalysis) {
                showTypingIndicator();
                
                try {
                    const formData = new FormData();
                    
                    // Add enabled transcript files
                    const enabledFiles = transcriptFiles.filter(f => f.enabled);
                    enabledFiles.forEach((fileObj, index) => {
                        formData.append(`file_${index}`, fileObj.file);
                    });
                    
                    if (isInitialAnalysis) {
                        formData.append('is_initial_analysis', 'true');
                        formData.append('message', '');
                    } else {
                        formData.append('is_initial_analysis', 'false');
                        formData.append('message', message);
                    }

                    const response = await fetch('/api/ai-chat', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    
                    hideTypingIndicator();

                    if (response.ok) {
                        addAIMessage(data.response);
                    } else {
                        addAIMessage(`Error: ${data.error || 'Something went wrong. Please try again.'}`);
                    }
                } catch (error) {
                    hideTypingIndicator();
                    addAIMessage('Error: Failed to connect to AI service. Please check your connection and try again.');
                    console.error('AI Chat error:', error);
                }
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai-chat.js') }}"></script>
</body>
</html>